# Use the base image with Node.js
FROM node:10.16.0

ARG NODE_ENV
ARG FORCE_DEV
ARG BABEL_ENV
ARG NODE_ENV_CONFIG
ARG ACCOUNTS_APP_CONNECTOR_URL
ARG ACCOUNTS_APP_LOGIN_URL
ARG COMMUNITY_APP_URL
ARG MEMBER_API_URL
ARG ARENA_URL
ARG DEV_APP_URL
ARG CHALLENGE_API_URL
ARG FILESTACK_API_KEY
ARG FILESTACK_SUBMISSION_CONTAINER
ARG SUBMISSION_REVIEW_API_URL
ARG REACT_APP_FILESTACK_API_KEY


ENV NODE_ENV=$NODE_ENV
ENV FORCE_DEV=$FORCE_DEV
ENV BABEL_ENV=$BABEL_ENV
ENV NODE_ENV_CONFIG=$NODE_ENV_CONFIG
ENV ACCOUNTS_APP_CONNECTOR_URL=$ACCOUNTS_APP_CONNECTOR_URL
ENV ACCOUNTS_APP_LOGIN_URL=$ACCOUNTS_APP_LOGIN_URL
ENV COMMUNITY_APP_URL=$COMMUNITY_APP_URL
ENV MEMBER_API_URL=$MEMBER_API_URL
ENV ARENA_URL=$ARENA_URL
ENV DEV_APP_URL=$DEV_APP_URL
ENV CHALLENGE_API_URL=$CHALLENGE_API_URL
ENV FILESTACK_API_KEY=$FILESTACK_API_KEY
ENV FILESTACK_SUBMISSION_CONTAINER=$FILESTACK_SUBMISSION_CONTAINER
ENV SUBMISSION_REVIEW_API_URL=$SUBMISSION_REVIEW_API_URL
ENV REACT_APP_FILESTACK_API_KEY=$REACT_APP_FILESTACK_API_KEY

RUN useradd -m -s /bin/bash appuser

# Copy the current directory into the Docker image
COPY . /submission-review-ui

RUN chown -R appuser:appuser /submission-review-ui
USER appuser

# Set working directory for future use
WORKDIR /submission-review-ui

# Install the dependencies from package.json
RUN npm config set unsafe-perm true
RUN git config --global url."https://git@".insteadOf git://
RUN npm install
RUN npm run lint
# RUN npm rebuild node-sass
RUN npm run build
# RUN npm run test

CMD npm start
